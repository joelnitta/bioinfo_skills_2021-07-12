<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>上級R編</title>
    <meta charset="utf-8" />
    <meta name="author" content="ニッタ ジョエル" />
    <meta name="date" content="2021-07-10" />
    <script src="index_files/header-attrs/header-attrs.js"></script>
    <script src="index_files/fabric/fabric.min.js"></script>
    <link href="index_files/xaringanExtra-scribble/scribble.css" rel="stylesheet" />
    <script src="index_files/xaringanExtra-scribble/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#FF0000"],"pen_size":3,"eraser_size":30,"palette":[]}) })</script>
    <link href="index_files/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# 上級R編
## 私のベストプラクティス
### ニッタ ジョエル
### 2021-07-10

---

class: inverse center middle







&lt;style&gt;
.big {
  font-size: 1.5rem;
}
&lt;/style&gt;

# Q: 何のためのベストプラクティス？

---
class: center middle

# A: 解析を再現するための&lt;br&gt;ベストプラクティス

---
## 再現性とは

.big[
&gt; 将来の自分を始め、誰でも**簡単に**同じ解析を行なって、&lt;br&gt;**同じ結果が得られる**ようにすること
]

---
## 何を目指す？

.big[「再現できる」]

---
## 何を目指す？

.big[❌「再現できる」]

--

.big[⭕**「なるべく再現しやすいようにする」**]


---
## 解析の要素

.big[
- データ

- コード

- 解析環境
]

---
## 再現性の要素

- データ
  - 全てのデータを公開する
  - データを説明する(ドキュメンテーション)
- コード
  - コードを公開する
  - バージョン管理を使う
  - 誰でも（将来の自分を含めて）理解できる
  - コードが自動的に動く
  - コードと結果が直接に結びついている
- 解析環境
  - 全てのソフトウエアのバージョンを記述
  - 誰でも（将来の自分を含めて）再現できる（コンテナを使う）

&lt;img src="images/grad-arrow.png" style="position:absolute; left:75%; top:22%; width:auto; max-height:65%"&gt;
&lt;div style="position:absolute; left:83%; top:22%"&gt;再現しづらい&lt;/div&gt;
&lt;div style="position:absolute; left:85%; top:80%"&gt;再現しやすい&lt;/div&gt;

---
## 再現性の要素

- データ
  - 全てのデータを公開する
  - データを説明する(ドキュメンテーション)
- **コード**
  - コードを公開する
  - バージョン管理を使う
  - 誰でも（将来の自分を含めて）理解できる
  - **コードが自動的に動く**
  - **コードと結果が直接に結びついている**
- **解析環境**
  - 全てのソフトウエアのバージョンを記述
  - **誰でも（将来の自分を含めて）再現できる（コンテナを使う）**

&lt;img src="images/grad-arrow.png" style="position:absolute; left:75%; top:22%; width:auto; max-height:65%"&gt;
&lt;div style="position:absolute; left:83%; top:22%"&gt;再現しづらい&lt;/div&gt;
&lt;div style="position:absolute; left:85%; top:80%"&gt;再現しやすい&lt;/div&gt;

---
class: center middle

# ネタバレ

---
## 最終的にこのようなことを目指す

- 一プロジェクト（一論文）が一つの**リポジトリー\***になっている
- リポジトリーがオンラインに公開している
- 誰でもダウンロードして、簡単に解析を再現することができる

.big[例：https://github.com/joelnitta/moorea_filmies]

.footnote[**\*リポジトリー** = バージョン管理のついたフォルダー]

---
class: center middle

# コードが自動的に動く
  
---
## Rプロジェクトを使いましょう！

❌ `setwd("joels_computer/projects/kato_daphnia")`←自分のパソコンにしか&lt;br&gt;存在しないパス

⭕ `kato_daphnia.Rproj`をクリック

.center[![List of folders and an .Rproj file](images/rpoj_file.png)]

---
## Rプロジェクトを使いましょう！

1. "File" メニューボタンをクリックし、"New Project"をクリック
2. "New Directory"をクリック
3. "Empty Project"をクリック
4. プロジェクトを保存するディレクトリの名前を入力
5. "Create Project" ボタンをクリック

---
## `here`パケージについて

Rプロジェクトと相対パスを使えば、絶対パスを指定する必要は基本的にありません。

が、**どうしても絶対パスが必要になった時\***は`here()`を使いましょう：


```r
here::here()
```

```
## [1] "/Users/joelnitta/repos/bioinfo_skills_2021-07-12"
```


```r
here::here("nested/folder/file")
```

```
## [1] "/Users/joelnitta/repos/bioinfo_skills_2021-07-12/nested/folder/file"
```

.footnote[**\*ドッカーをマウントする時、Rmarkdownに使うファイルのパスを指定する時**]

---
## `targets`パケージについて

イメージ：Rの`makefile`

###「バイオインフォ」12.3（p448）

- 元々はソフトウエアをコンパイルするために生まれた

- 自動的に依存関係を認識し、目的のファイルを作る

---
## `targets`パケージについて

### プロジェクト構造

.big[
```
├── _targets.R
├── R/
  └──── functions.R
├── data/
  └──── raw_data.csv
```
]

---
## `targets`パケージについて

.pull-left[
### `_targets.R`

```r
library(targets)
library(tarchetypes)
library(tidyverse)
library(biglm)
source("R/functions.R")
list(
  tar_target(
    raw_data,
    read_csv("data/raw_data.csv")
  ),
  tar_target(
    data,
    filter(raw_data, !is.na(Ozone))
  ),
  tar_target(hist, create_plot(data)),
  tar_render(report, "index.Rmd")
)
```
]

.pull-right[
### `functions.R`

```r
create_plot &lt;- function(data) {
  ggplot(data) +
    geom_histogram(aes(x = Ozone), bins = 12) +
    theme_gray(24)
}
```
]

---
## `targets`パケージについて

.big[例：https://github.com/wlandau/targets-minimal]

---
## `targets`パケージの特徴

- データの読み込みから論文まで、**全てのステップを自動的に行う**
- 何かが変わった時、**必要なステップのみを実行する**
- 簡単に**パラレル化**できる
- Rコマンドにも、R以外のコマンドにも使える

---
## Rから他のソフトを走らせる方法

&lt;!-- see https://github.com/yihui/knitr/issues/1203 --&gt;

### 一番簡単：`system()`

```r
system("ls")
```


```
## bioinfo_skills_2021-07-12.Rproj
## data
## images
## index.Rmd
## index.html
## index_files
## libs
## packages_dev.R
## renv
## renv.lock
## xaringan-themer.css
```

---
## Rから他のソフトを走らせる方法

### 上級：`processx::run()`

```r
library(processx)
run(
  command = "ls", 
  args = c("-a", "-h"), 
  wd = "data")
```

```
## $status
## [1] 0
## 
## $stdout
## [1] ".\n..\nraw_data.csv\n"
## 
## $stderr
## [1] ""
## 
## $timeout
## [1] FALSE
```

---
class: center middle

# 解析環境
  
---
## `renv`パケージについて

イメージ：pythonのconda、virtualenvみたいなパケージ管理システム

---
## `renv`パケージについて

Rのデフォルト設定では、全てのパッケージは**同じ（プロジェクト意外の）場所**に保管される（「ライブラリー」と呼ばれる）


```r
.libPaths()
```




```
## [1] "/Library/Frameworks/R.framework/Versions/4.1/Resources/library"
```

---
## `renv`パケージについて

`renv`を使うと、各プロジェクトが**そのプロジェクトだけのライブラリー**を持つ


```r
.libPaths()
```

```
## [1] "/Users/joelnitta/repos/bioinfo_skills_2021-07-12/renv/library/R-4.1/x86_64-apple-darwin17.0"
## [2] "/private/var/folders/8c/xp3x28zx3fd3llvggl2y17h00000gn/T/RtmpWNdgGr/renv-system-library"
```

---
## `renv`の重要なコマンド：

`renv::init()`: プロジェクトのライブラリーを作る

`renv::snapshot()`：ライブラリーの現状を`renv.lock`ファイルに記録する

`renv::restore()`：`renv.lock`からライブラリーを復元する

---
## `renv.lock`ファイルの中身

.pull-left[
- パッケージ名
- バージョン
- 由来
- ハッシュ

### 大事：`renv.lock`をgitで保存(コミット)する

]

.pull-right[
```
{
  "R": {
    "Version": "4.1.0",
    "Repositories": [
      {
        "Name": "CRAN",
        "URL": "https://cran.rstudio.com"
      }
    ]
  },
  "Packages": {
    "R6": {
      "Package": "R6",
      "Version": "2.5.0",
      "Source": "Repository",
      "Repository": "CRAN",
      "Hash": "b203113193e70978a696b2809525649d"
    }
...
```
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
